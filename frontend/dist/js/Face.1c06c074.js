(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["Face"],{"6b31":function(t,e,s){"use strict";s("8a05")},"8a05":function(t,e,s){},b739:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"face"},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.showContainer,expression:"showContainer"}],staticClass:"face-capture",attrs:{id:"face-capture"}},[i("video",{ref:"refVideo",staticStyle:{width:"100vw",height:"100vh"},attrs:{id:"video"}}),i("img",{staticClass:"img-cover",attrs:{src:s("6b3b"),alt:"cover"}}),i("div",{staticClass:"control-container face-capture"},[i("h2",{staticClass:"title"},[t._v(t._s(t.scanTip))]),i("img",{staticClass:"close",attrs:{src:s("f7d2"),alt:""},on:{click:t.exit}}),i("canvas",{ref:"refCanvas",style:{opacity:0},attrs:{width:t.screenSize.width,height:t.screenSize.height}})]),t._l(t.profile,(function(t,e){return i("div",{key:e,staticClass:"rect",style:{width:t.width+"px",height:t.height+"px",left:t.left+"px",top:t.top+"px"}})}))],2),i("canvas",{ref:"refCanvas2",staticStyle:{opacity:"0",display:"none"},attrs:{width:t.screenSize.width,height:t.screenSize.height}}),i("img",{directives:[{name:"show",rawName:"v-show",value:!t.showContainer,expression:"!showContainer"}],ref:"savedImg",attrs:{src:t.imgUrl}})])},a=[];s("9db3"),s("81f4"),s("33ea"),s("f9ef");var r={name:"Face",components:{},data(){return{screenSize:{width:window.screen.width,height:window.screen.height},URL:null,streamIns:null,showContainer:!0,tracker:null,tipFlag:!1,flag:!1,context:null,profile:[],removePhotoID:null,scanTip:"人脸识别中...",imgUrl:""}},mounted(){this.playVideo()},methods:{getUserMedia(t,e,s){navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(t).then(e).catch(s):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(t).then(e).catch(s):navigator.mozGetUserMedia?navagator.mozGetUserMedia(t).then(e).catch(s):navigator.getUserMedia?navigator.getUserMedia(t).then(e).catch(s):this.scanTip="你的浏览器不支持访问用户媒体设备"},success(t){this.streamIns=t,this.URL=window.URL||window.webkitURL,"srcObject"in this.$refs.refVideo?this.$refs.refVideo.srcObject=t:this.$refs.refVideo.src=this.URL.createObjectURL(t),this.$refs.refVideo.onloadedmetadata=t=>{this.$refs.refVideo.play(),this.initTracker()}},error(t){this.scanTip="访问用户媒体失败"+t.name+","+t.message},playVideo(){this.getUserMedia({video:{width:1920,height:1080,facingMode:"user"}},this.success,this.error)},initTracker(){this.context=this.$refs.refCanvas.getContext("2d"),this.tracker=new tracking.ObjectTracker(["face"]),this.tracker.setStepSize(.4),this.tracker.on("track",this.handleTracked);try{tracking.track("#video",this.tracker)}catch(t){this.scanTip="访问用户媒体失败，请重试"}},handleTracked(t){0===t.data.length?this.scanTip="未检测到人脸":(this.tipFlag||(this.scanTip="检测成功，正在拍照，请保持不动2秒"),this.flag||(this.scanTip="拍照中...",this.flag=!0,this.removePhotoID=setTimeout(()=>{this.tackPhoto(),this.tipFlag=!0},2e3)),t.data.forEach(this.plot))},plot({x:t,y:e,width:s,height:i}){this.profile.push({width:s,height:i,left:t,top:e})},tackPhoto(){try{this.context.drawImage(this.$refs.refVideo,0,0,this.screenSize.width,this.screenSize.height),this.imgUrl=this.saveAsPNG(this.$refs.refCanvas),this.compare()}catch(t){this.Dialog.confirm({message:"人脸检测失败。",confirmButtonText:"重试"}).then(()=>{location.reload()}).catch(()=>{this.$router.go(-1)})}},getBlobBydataURI(t,e){for(var s=window.atob(t.split(",")[1]),i=[],a=0;a<s.length;a++)i.push(s.charCodeAt(a));return new Blob([new Uint8Array(i)],{type:e})},saveAsPNG(t){return t.toDataURL("image/png",.3)},close(){this.flag=!1,this.tipFlag=!1,this.showFailPop=!1,this.showContainer=!1,this.tracker&&this.tracker.removeListener("track",this.handleTracked),this.tracker=null,this.context=null,this.profile=[],this.scanTip="人脸识别中...",clearTimeout(this.removePhotoID),this.streamIns&&(this.streamIns.enabled=!1,this.streamIns.getTracks()[0].stop(),this.streamIns.getVideoTracks()[0].stop()),this.streamIns=null},compare(){this.Toast.loading({message:"人脸录入中...",forbidClick:!0});let t=this.imgUrl.split("data:image/png;base64,")[1];this.$axios.post({url:"/user/face",data:{face:t}}).then(t=>{console.log(111),"0"==t.code?(this.Toast.success("录入成功"),setTimeout(()=>{this.$router.replace("/myshow/faces")},3e3)):(this.Toast.fail("录入失败，请重试"),setTimeout(()=>{this.$router.go(0)},3e3))})},exit(){this.close(),this.$router.replace("/myshow/faces")}}},h=r,o=(s("6b31"),s("2877")),c=Object(o["a"])(h,i,a,!1,null,"0bf9c036",null);e["default"]=c.exports}}]);
//# sourceMappingURL=Face.1c06c074.js.map