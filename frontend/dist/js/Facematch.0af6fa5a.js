(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["Facematch"],{"2de1":function(t,e,i){"use strict";i("561a")},"561a":function(t,e,i){},c2c5:function(t,e,i){"use strict";i.r(e);var s=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"face"},[s("div",{directives:[{name:"show",rawName:"v-show",value:t.showContainer,expression:"showContainer"}],staticClass:"face-capture",attrs:{id:"face-capture"}},[s("video",{ref:"refVideo",staticStyle:{width:"100vw",height:"100vh"},attrs:{id:"video"}}),s("img",{staticClass:"img-cover",attrs:{src:i("6b3b"),alt:"cover"}}),s("div",{staticClass:"control-container face-capture"},[s("h2",{staticClass:"title"},[t._v(t._s(t.scanTip))]),s("img",{staticClass:"close",attrs:{src:i("f7d2"),alt:""},on:{click:t.exit}}),s("canvas",{ref:"refCanvas",style:{opacity:0},attrs:{width:t.screenSize.width,height:t.screenSize.height}})]),t._l(t.profile,(function(t,e){return s("div",{key:e,staticClass:"rect",style:{width:t.width+"px",height:t.height+"px",left:t.left+"px",top:t.top+"px"}})}))],2),s("canvas",{ref:"refCanvas2",staticStyle:{opacity:"0",display:"none"},attrs:{width:t.screenSize.width,height:t.screenSize.height}}),s("img",{directives:[{name:"show",rawName:"v-show",value:!t.showContainer,expression:"!showContainer"}],ref:"savedImg",attrs:{src:t.imgUrl}})])},a=[];i("9db3"),i("81f4"),i("33ea"),i("f9ef");var r={name:"Facematch",components:{},data(){return{screenSize:{width:window.screen.width,height:window.screen.height},URL:null,streamIns:null,showContainer:!0,tracker:null,tipFlag:!1,flag:!1,context:null,profile:[],removePhotoID:null,scanTip:"人脸识别中...",imgUrl:""}},mounted(){this.playVideo()},methods:{getUserMedia(t,e,i){navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(t).then(e).catch(i):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(t).then(e).catch(i):navigator.mozGetUserMedia?navagator.mozGetUserMedia(t).then(e).catch(i):navigator.getUserMedia?navigator.getUserMedia(t).then(e).catch(i):this.scanTip="你的浏览器不支持访问用户媒体设备"},success(t){this.streamIns=t,this.URL=window.URL||window.webkitURL,"srcObject"in this.$refs.refVideo?this.$refs.refVideo.srcObject=t:this.$refs.refVideo.src=this.URL.createObjectURL(t),this.$refs.refVideo.onloadedmetadata=t=>{this.$refs.refVideo.play(),this.initTracker()}},error(t){this.scanTip="访问用户媒体失败"+t.name+","+t.message},playVideo(){this.getUserMedia({video:{width:1920,height:1080,facingMode:"user"}},this.success,this.error)},initTracker(){this.context=this.$refs.refCanvas.getContext("2d"),this.tracker=new tracking.ObjectTracker(["face"]),this.tracker.setStepSize(.4),this.tracker.on("track",this.handleTracked);try{tracking.track("#video",this.tracker)}catch(t){this.scanTip="访问用户媒体失败，请重试"}},handleTracked(t){0===t.data.length?this.scanTip="未检测到人脸":(this.tipFlag||(this.scanTip="检测成功，正在拍照，请保持不动2秒"),this.flag||(this.scanTip="拍照中...",this.flag=!0,this.removePhotoID=setTimeout(()=>{this.tackPhoto(),this.tipFlag=!0},2e3)),t.data.forEach(this.plot))},plot({x:t,y:e,width:i,height:s}){this.profile.push({width:i,height:s,left:t,top:e})},tackPhoto(){try{this.context.drawImage(this.$refs.refVideo,0,0,this.screenSize.width,this.screenSize.height),this.imgUrl=this.saveAsPNG(this.$refs.refCanvas),this.compare()}catch(t){this.Dialog.confirm({message:"人脸检测失败。",confirmButtonText:"重试"}).then(()=>{location.reload()}).catch(()=>{this.$router.go(-1)})}this.close()},getBlobBydataURI(t,e){for(var i=window.atob(t.split(",")[1]),s=[],a=0;a<i.length;a++)s.push(i.charCodeAt(a));return new Blob([new Uint8Array(s)],{type:e})},saveAsPNG(t){return t.toDataURL("image/png",.3)},close(){this.flag=!1,this.tipFlag=!1,this.showFailPop=!1,this.showContainer=!1,this.tracker&&this.tracker.removeListener("track",this.handleTracked),this.tracker=null,this.context=null,this.profile=[],this.scanTip="人脸识别中...",clearTimeout(this.removePhotoID),this.streamIns&&(this.streamIns.enabled=!1,this.streamIns.getTracks()[0].stop(),this.streamIns.getVideoTracks()[0].stop()),this.streamIns=null},compare(){this.Toast.loading({message:"人脸对比中",forbidClick:!0});let t=this.imgUrl.split("data:image/png;base64,")[1];this.$axios.post({url:"/punch_card/check",data:{humanFace:t}}).then(t=>{"0"==t.code?this.Dialog.alert({message:"打卡成功！"}).then(()=>{this.$router.replace("/clock")}):this.Dialog.confirm({message:"打卡失败,请重试！",confirmButtonText:"重试"}).then(()=>{this.close(),this.$router.go(0)}).catch(()=>{this.close(),this.$router.replace("/clock")})})},exit(){this.close(),this.$router.replace("/clock")}}},h=r,c=(i("2de1"),i("2877")),o=Object(c["a"])(h,s,a,!1,null,"6cf66990",null);e["default"]=o.exports}}]);
//# sourceMappingURL=Facematch.0af6fa5a.js.map